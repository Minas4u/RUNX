<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios Marathon Plan & Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
            color: #292524; /* stone-800 */
        }
        .main-container {
            background-color: #ffffff; /* white */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
        }
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500;
        }
        .nav-button.active {
            background-color: #0284c7; /* sky-600 */
            color: white;
        }
        .nav-button:not(.active):hover {
            background-color: #e0f2fe; /* sky-100 */
            color: #0369a1; /* sky-700 */
        }
        .phase-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            border-width: 1px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500;
        }
        .phase-button-preseason { border-color: #d1d5db; color: #4b5563; }
        .phase-button-preseason:hover:not(.active) { background-color: #f3f4f6; }
        .phase-button-preseason.active { background-color: #6b7280; color: white; border-color: #6b7280; }
        .phase-button-base { border-color: #0ea5e9; color: #0369a1; }
        .phase-button-base:hover:not(.active) { background-color: #e0f2fe; }
        .phase-button-base.active { background-color: #0ea5e9; color: white; }
        .phase-button-specific { border-color: #10b981; color: #047857; }
        .phase-button-specific:hover:not(.active) { background-color: #d1fae5; }
        .phase-button-specific.active { background-color: #059669; color: white; border-color: #059669; }
        .phase-button-taper { border-color: #ef4444; color: #b91c1c; }
        .phase-button-taper:hover:not(.active) { background-color: #fee2e2; }
        .phase-button-taper.active { background-color: #dc2626; color: white; border-color: #dc2626; }
        .week-button {
            padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #9ca3af; /* gray-400 */
            color: #374151; /* gray-700 */ font-weight: 500; text-align: center;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .week-button.active { background-color: #0d9488; color: white; border-color: #0d9488; }
        .week-button:not(.active):hover { background-color: #f0fdfa; border-color: #14b8a6; }
        .content-card {
            background-color: #fafaf9; /* stone-50 */ padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */ border: 1px solid #e7e5e4; /* stone-200 */
        }
        .content-card h3 { color: #0d9488; /* teal-600 */ }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .data-table { width: 100%; margin-top: 0.5rem; border-collapse: collapse; font-size: 0.875rem; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        .data-table th { font-weight: 600; background-color: #f3f4f6; }
        .schedule-table { width: 100%; margin-top: 0.75rem; border-collapse: collapse; font-size: 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .schedule-table th, .schedule-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .schedule-table th { background-color: #f9fafb; color: #374151; font-weight: 600; }
        .schedule-table tr:last-child td { border-bottom: none; }
        .schedule-table td:first-child { font-weight: 500; width: 25%; max-width: 100px; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus {
            outline: 2px solid transparent; outline-offset: 2px; border-color: #0ea5e9; /* sky-500 */
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
        }
        .header-logo-container { display: inline-block; padding: 0.75rem; background-color: #0284c7; border-radius: 0.5rem; }
        .header-logo { max-height: 50px; display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #loading-message, #error-message { text-align: center; padding: 2rem; font-size: 1.125rem; font-weight: 500; }
        #loading-message { color: #0369a1; }
        #error-message { color: #dc2626; background-color: #fee2e2; border: 1px solid #f87171; border-radius: 0.5rem; }
        
        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
        .calendar-header { text-align: center; padding: 0.5rem; background-color: #f9fafb; font-weight: 600; font-size: 0.875rem; color: #374151; }
        .calendar-day { background-color: #fff; padding: 0.5rem; min-height: 100px; font-size: 0.75rem; border: 1px solid #f3f4f6; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-day.is-today { background-color: #ecfdf5; /* green-50 */ border: 2px solid #10b981; /* green-500 */ }
        .calendar-day .day-number { font-weight: 600; margin-bottom: 0.25rem; display: block; }
        
        .activity-thumbnail { 
            display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            padding: 0.25rem; border-radius: 0.25rem; margin-top: 0.25rem;
            font-size: 0.7rem; /* Slightly smaller font for thumbnails */
        }
        .activity-thumbnail-easy { background-color: #e0f2fe; color: #0c4a6e; } /* sky-100, sky-800 */
        .activity-thumbnail-tempo { background-color: #ffedd5; color: #c2410c; } /* orange-100, orange-700 */
        .activity-thumbnail-interval { background-color: #fee2e2; color: #b91c1c; } /* red-100, red-700 */
        .activity-thumbnail-long { background-color: #f3e8ff; color: #7e22ce; } /* purple-100, purple-700 */
        .activity-thumbnail-race { background-color: #fce7f3; color: #be185d; } /* pink-100, pink-700 */
        .activity-thumbnail-rest { background-color: #f1f5f9; color: #475569; } /* slate-100, slate-600 */
        .activity-thumbnail-default { background-color: #e0f2fe; color: #0c4a6e; } /* Default: same as easy */


        #todays-training-card { border-left: 4px solid #0ea5e9; /* sky-500 */ }
    </style>
</head>
<body class="min-h-screen p-4 py-8">
    <div class="main-container w-full max-w-5xl mx-auto p-6 sm:p-8">
        <header class="mb-6 sm:mb-8 text-center">
            <div class="header-logo-container">
                <img src="https://iliosports.com/wp-content/uploads/2021/03/logo-13.png"
                     alt="Helios Running Team Logo"
                     class="header-logo"
                     onerror="this.parentElement.innerHTML='<h1 class=\'text-2xl sm:text-3xl font-bold text-white\'>Helios Running</h1>'">
            </div>
            <h1 class="text-2xl sm:text-3xl font-bold text-stone-800 mt-4">Marathon Plan & Training Tools</h1>
            <p class="text-stone-600">Your interactive guide to marathon training and pace utilities.</p>
        </header>

        <nav class="mb-8 flex flex-wrap justify-center gap-2 sm:gap-4 border-b border-stone-300 pb-4">
            <button id="nav-overview" class="nav-button active">Plan Overview</button>
            <button id="nav-plan" class="nav-button">Training Plan</button>
            <button id="nav-calendar" class="nav-button">Calendar</button>
            <button id="nav-utils" class="nav-button">Pace Utilities</button>
        </nav>

        <main id="app-content">
            <div id="loading-message">
                <svg class="animate-spin h-8 w-8 text-sky-600 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading training plan data from Google Sheet...
            </div>
            <div id="error-message" class="hidden"></div>
            </main>
    </div>

<script>
// --- Configuration ---
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwDUePACew4T4yiaL5oRqXSobZHb6m-ONujQirZoARs4t7ILJpRbjAz-N1HLtOPZKw-/exec'; // Replace with your actual Web App URL
const DEFAULT_RACE_DATE_STRING = '2025-11-09';

// --- Global Variables ---
let marathonPlan = null;
let datedTrainingPlan = []; // To store activities mapped to specific dates
let currentRaceDate = null; // Stores the user-set race date
let calendarCurrentDisplayDate = new Date(); // For calendar month navigation

const appContent = document.getElementById('app-content');
const loadingMessageDiv = document.getElementById('loading-message');
const errorMessageDiv = document.getElementById('error-message');
let mileageChartInstance = null;

// --- Data Fetching and Initialization ---
async function fetchMarathonPlan() {
    try {
        const response = await fetch(WEB_APP_URL);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}. Details: ${errorText}`);
        }
        const data = await response.json();
        if (data.error) {
            throw new Error(`Error from Google Sheet App: ${data.error}`);
        }
        // Basic validation of the fetched data structure
        if (!data.philosophy || !data.philosophy.title || !Array.isArray(data.philosophy.content) ||
            !data.paceGuide || !data.paceGuide.title || !Array.isArray(data.paceGuide.paces) ||
            !data.generalNotes || !data.generalNotes.title || !Array.isArray(data.generalNotes.notes) ||
            !Array.isArray(data.phases)) {
            console.error("Fetched data is missing essential properties or has an unexpected structure:", data);
            throw new Error("Fetched data is incomplete. Check Apps Script `doGet` and Google Sheet structure.");
        }
        marathonPlan = data;

        // Initialize race date: from localStorage or default
        const storedRaceDate = localStorage.getItem('marathonRaceDate');
        if (storedRaceDate) {
            const parsedDate = new Date(storedRaceDate + 'T00:00:00'); // Ensure local timezone interpretation
            if (isValidDate(parsedDate)) {
                currentRaceDate = parsedDate;
            }
        }
        
        if (!currentRaceDate) { // If no valid date from localStorage, use default
            currentRaceDate = new Date(DEFAULT_RACE_DATE_STRING + 'T00:00:00');
            localStorage.setItem('marathonRaceDate', DEFAULT_RACE_DATE_STRING); // Store default if used
        }
        
        calculateAndStoreDatedTrainingPlan(currentRaceDate);
        calendarCurrentDisplayDate = new Date(currentRaceDate.getFullYear(), currentRaceDate.getMonth(), 1);
        
        initializeApp();
    } catch (error) {
        console.error('Failed to fetch marathon plan:', error);
        if(loadingMessageDiv) loadingMessageDiv.classList.add('hidden');
        if(errorMessageDiv) {
            errorMessageDiv.textContent = `Error loading training plan: ${error.message}. Please ensure the Google Sheet is accessible and the Apps Script is deployed correctly (check 'Who has access' is 'Anyone'). You might need to check the Apps Script logs for more details.`;
            errorMessageDiv.classList.remove('hidden');
        }
    }
}

function initializeApp() {
    if(loadingMessageDiv) loadingMessageDiv.classList.add('hidden');
    if(errorMessageDiv) errorMessageDiv.classList.add('hidden');
    if(appContent) appContent.innerHTML = '';

    document.getElementById('nav-overview').addEventListener('click', renderOverview);
    document.getElementById('nav-plan').addEventListener('click', renderTrainingPlan);
    document.getElementById('nav-calendar').addEventListener('click', renderCalendarTab);
    document.getElementById('nav-utils').addEventListener('click', renderPaceUtilities);
    
    renderOverview(); // Default view
}

function setActiveNav(activeId) {
    document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.id === activeId) {
            btn.classList.add('active');
        }
    });
}

function createHtmlList(items) {
    if (!items || !Array.isArray(items)) return '';
    return `<ul class="list-disc list-inside space-y-1 text-stone-700">${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
}

// --- Date Helper Functions ---
function isValidDate(d) {
  return d instanceof Date && !isNaN(d);
}

function formatDate(date, options = { year: 'numeric', month: 'long', day: 'numeric' }) {
    if (!isValidDate(date)) return "N/A";
    return date.toLocaleDateString(undefined, options);
}

function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

function isSameDay(date1, date2) {
    if (!isValidDate(date1) || !isValidDate(date2)) return false;
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
}

// --- Training Plan Date Calculation ---
function calculateAndStoreDatedTrainingPlan(raceDateInput) {
    if (!marathonPlan || !marathonPlan.phases || !isValidDate(raceDateInput)) {
        datedTrainingPlan = [];
        console.warn("Cannot calculate dated plan: Missing plan data or invalid race date.", marathonPlan, raceDateInput);
        return;
    }
    currentRaceDate = new Date(raceDateInput); 
    localStorage.setItem('marathonRaceDate', currentRaceDate.toISOString().split('T')[0]);

    let allDaysScheduled = [];
    marathonPlan.phases.forEach(phase => {
        phase.weeks.forEach(week => {
            week.days.forEach(dayString => {
                allDaysScheduled.push({
                    activity: dayString, 
                    notes: week.notes || "",
                    phaseName: phase.name,
                    weekNum: week.weekNum,
                    totalKm: week.totalKm
                });
            });
        });
    });

    datedTrainingPlan = [];
    let tempCurrentDate = new Date(currentRaceDate); 

    for (let i = allDaysScheduled.length - 1; i >= 0; i--) {
        const scheduledItem = allDaysScheduled[i];
        datedTrainingPlan.unshift({ 
            date: new Date(tempCurrentDate),
            ...scheduledItem
        });
        tempCurrentDate = addDays(tempCurrentDate, -1); 
    }
}


// --- "Today's Training" Section ---
function renderTodaysTraining() {
    const container = document.getElementById('todays-training-content');
    if (!container) return;

    if (!currentRaceDate) {
        container.innerHTML = `
            <p class="text-sm text-sky-700">
                Set your race date in the <button onclick="document.getElementById('nav-calendar').click();" class="underline font-semibold">Calendar Tab</button> to see today's training. Default is ${DEFAULT_RACE_DATE_STRING}.
            </p>`;
        return;
    }
    
    // Ensure datedTrainingPlan is populated if currentRaceDate exists but plan is empty
    if (datedTrainingPlan.length === 0 && currentRaceDate && marathonPlan) {
         calculateAndStoreDatedTrainingPlan(currentRaceDate);
    }
    
    const today = new Date();
    today.setHours(0,0,0,0); // Normalize today's date to midnight for accurate comparison

    const todaysActivity = datedTrainingPlan.find(item => {
        const itemDate = new Date(item.date);
        itemDate.setHours(0,0,0,0); // Normalize item date
        return isSameDay(itemDate, today);
    });


    if (todaysActivity) {
        const dayName = todaysActivity.date.toLocaleDateString(undefined, { weekday: 'long' });
        let activityText = todaysActivity.activity.replace(/^[^:]+:\s*/, ''); // Remove "Mon: " prefix for display
        let activityHtml = `<p class="text-stone-700">${activityText}</p>`; 

        container.innerHTML = `
            <h3 class="text-lg font-semibold text-sky-700 mb-1">Today's Training (${dayName}, ${formatDate(today)})</h3>
            ${activityHtml}
            ${todaysActivity.notes ? `<p class="text-sm text-stone-600 italic mt-1"><strong>Weekly Notes:</strong> ${todaysActivity.notes}</p>` : ''}
            <p class="text-xs text-stone-500 mt-1">Phase: ${todaysActivity.phaseName} | Week: ${todaysActivity.weekNum}</p>
        `;
    } else {
        container.innerHTML = `
            <h3 class="text-lg font-semibold text-sky-700 mb-1">Today's Training (${formatDate(today)})</h3>
            <p class="text-stone-700">No specific training scheduled for today based on your race date (${formatDate(currentRaceDate)}), or you are outside the plan's duration.</p>
            <p class="text-sm text-stone-600">This might be a rest day or before the plan starts / after it ends.</p>
        `;
    }
}

// --- Plan Overview Tab ---
function renderOverview() {
    if (!marathonPlan) return;
    setActiveNav('nav-overview');
    appContent.innerHTML = ''; 

    const overviewSection = document.createElement('section');
    overviewSection.id = "overview-content";
    overviewSection.className = "space-y-6";

    overviewSection.innerHTML = `
        <div id="todays-training-card" class="content-card p-4 mb-6">
            <div id="todays-training-content">
                </div>
        </div>
        <div class="content-card">
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">${marathonPlan.philosophy.title || 'Training Philosophy'}</h2>
            ${createHtmlList(marathonPlan.philosophy.content)}
        </div>
        <div class="content-card">
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">Overall Mileage Progression</h2>
            <div class="chart-container bg-white p-2 rounded-md shadow">
                <canvas id="mileageChart"></canvas>
            </div>
            <p class="text-xs text-stone-500 mt-2 text-center">Hover over points to see weekly mileage. Data sourced from "Mileage Data" sheet.</p>
        </div>
        <div class="content-card">
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">${marathonPlan.paceGuide.title || 'Pace Guide'}</h2>
            ${createHtmlList(marathonPlan.paceGuide.paces)}
        </div>
        <div class="content-card">
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">${marathonPlan.generalNotes.title || 'Important Notes'}</h2>
            ${createHtmlList(marathonPlan.generalNotes.notes)}
        </div>
    `;
    appContent.appendChild(overviewSection);
    renderTodaysTraining(); 
    renderMileageChart();
}

function renderMileageChart() {
    if (!marathonPlan || !marathonPlan.phases) {
        console.warn("Mileage chart: marathonPlan or phases data not available.");
        return;
    }
    const chartCanvas = document.getElementById('mileageChart');
    if (!chartCanvas) {
        return;
    }
    const labels = [];
    const dataPoints = [];
    marathonPlan.phases.forEach(phase => {
        if (!phase.weeks || !Array.isArray(phase.weeks)) {
            console.warn("Phase missing weeks array for chart:", phase.name);
            return; 
        }
        phase.weeks.forEach(week => {
            labels.push(`W${week.weekNum}`);
            let kmValue = typeof week.chartKm === 'number' ? week.chartKm : 0;
            if (typeof week.chartKm !== 'number' && typeof week.totalKm === 'string') { 
                const match = week.totalKm.match(/(\d+)/); 
                if (match) kmValue = parseInt(match[1], 10);
            } else if (typeof week.chartKm !== 'number' && typeof week.totalKm === 'number') {
                 kmValue = week.totalKm;
            }
            dataPoints.push(kmValue);
        });
    });
    if (mileageChartInstance) {
        mileageChartInstance.destroy();
    }
    mileageChartInstance = new Chart(chartCanvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Planned Weekly Kilometers', data: dataPoints, borderColor: '#0d9488', 
                backgroundColor: 'rgba(13, 148, 136, 0.1)', tension: 0.1, fill: true,
                pointBackgroundColor: '#0d9488', pointBorderColor: '#fff', pointHoverRadius: 7,
                pointHoverBackgroundColor: '#0d9488'
            }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Kilometers (km)', font: { weight: '500' } } },
                x: { title: { display: true, text: 'Training Week', font: { weight: '500' } }, ticks: { autoSkip: true, maxTicksLimit: 20, callback: function(v,i,vals){ return this.getLabelForValue(v);}} }
            },
            plugins: {
                tooltip: { enabled: true, mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { weight: 'bold' }, callbacks: { label: function(ctx) { return `${ctx.dataset.label}: ${ctx.parsed.y} km`; } } },
                legend: { labels: { font: { weight: '500' } } }
            }
        }
    });
}

function getPhaseButtonClass(phaseName) {
    const nameLower = phaseName.toLowerCase();
    if (nameLower.includes("preseason")) return "phase-button-preseason";
    if (nameLower.includes("base")) return "phase-button-base";
    if (nameLower.includes("specific")) return "phase-button-specific";
    if (nameLower.includes("taper")) return "phase-button-taper";
    return "phase-button-base";
}

function renderTrainingPlan() {
    if (!marathonPlan) return;
    setActiveNav('nav-plan');
    appContent.innerHTML = ''; 
    const trainingPlanSection = document.createElement('section');
    trainingPlanSection.id = "training-plan-content";
    trainingPlanSection.className = "space-y-6";
    const phaseButtonsHtml = marathonPlan.phases.map((phase, index) => {
        const buttonClass = getPhaseButtonClass(phase.name);
        return `<button class="phase-button ${buttonClass}" data-phase-index="${index}">${phase.name}</button>`
    }).join('');
    trainingPlanSection.innerHTML = `
        <div>
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-4">Select Training Phase:</h2>
            <div id="phase-navigation" class="flex flex-wrap gap-2 mb-6">
                ${phaseButtonsHtml}
            </div>
            <div id="phase-details" class="space-y-4">
                <p class="text-stone-600 italic">Select a phase to see its details and weekly breakdown.</p>
            </div>
        </div>
        <div id="week-details-container" class="mt-6"></div>
    `;
    appContent.appendChild(trainingPlanSection);
    document.querySelectorAll('#phase-navigation .phase-button').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll('#phase-navigation .phase-button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            const phaseIndex = parseInt(e.target.dataset.phaseIndex);
            renderPhaseDetails(phaseIndex);
        });
    });
    if (marathonPlan.phases && marathonPlan.phases.length > 0) {
        const firstPhaseButton = document.querySelector('#phase-navigation .phase-button');
        if (firstPhaseButton) {
            firstPhaseButton.classList.add('active'); 
            renderPhaseDetails(0); 
        }
    }
}

function formatPhaseDuration(durationString) {
    if (!durationString || typeof durationString !== 'string') return 'N/A';
    const weeksMatch = durationString.match(/(\S+\s+Weeks)/i); 
    const dateMatch = durationString.match(/\(([^)]+)\)/);   
    let weeksPart = "";
    let datePart = "";
    if (weeksMatch) {
        weeksPart = `[${weeksMatch[1].replace('~','').trim()}]`;
    }
    if (dateMatch) {
        let dates = dateMatch[1];
        const monthReplacements = {
            "January": "Jan", "February": "Feb", "March": "Mar", "April": "Apr",
            "May": "May", "June": "Jun", "July": "Jul", "August": "Aug",
            "September": "Sep", "October": "Oct", "November": "Nov", "December": "Dec"
        };
        for (const longMonth in monthReplacements) {
            dates = dates.replace(new RegExp(longMonth, "g"), monthReplacements[longMonth]);
        }
        datePart = `(${dates})`;
    }
    return `${weeksPart} ${datePart}`.trim();
}

function renderPhaseDetails(phaseIndex) {
    if (!marathonPlan) return;
    const phase = marathonPlan.phases[phaseIndex];
    if (!phase) {
        console.error("Phase not found for index:", phaseIndex);
        const phaseDetailsDiv = document.getElementById('phase-details');
        if(phaseDetailsDiv) phaseDetailsDiv.innerHTML = '<p class="text-red-500">Error: Could not load phase details.</p>';
        return;
    }
    const phaseDetailsDiv = document.getElementById('phase-details');
    const weekDetailsContainer = document.getElementById('week-details-container');
    if(weekDetailsContainer) weekDetailsContainer.innerHTML = ''; 
    const weekButtonsHtml = (phase.weeks && Array.isArray(phase.weeks)) ? phase.weeks.map((week, index) =>
        `<button class="week-button" data-phase-index="${phaseIndex}" data-week-index="${index}">Week ${week.weekNum}</button>`
    ).join('') : '<p>No weeks available for this phase.</p>';
    const formattedDuration = formatPhaseDuration(phase.duration);
    if(phaseDetailsDiv) phaseDetailsDiv.innerHTML = `
        <div class="content-card">
            <h3 class="text-lg sm:text-xl font-semibold mb-2">${phase.name} ${formattedDuration}</h3>
            <p class="text-sm text-stone-600 mb-1"><strong>Goal:</strong> ${phase.goal || 'N/A'}</p>
            <p class="text-sm text-stone-600 mb-3"><strong>Mileage Range:</strong> ${phase.mileageRange || 'N/A'}</p>
            <h4 class="text-md font-medium text-stone-700 mb-2">Select a Week:</h4>
            <div id="week-navigation-${phaseIndex}" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-7 gap-2">
                ${weekButtonsHtml}
            </div>
        </div>
    `;
    document.querySelectorAll(`#week-navigation-${phaseIndex} .week-button`).forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll(`#week-navigation-${phaseIndex} .week-button`).forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            const pIdx = parseInt(e.target.dataset.phaseIndex);
            const wIdx = parseInt(e.target.dataset.weekIndex);
            renderWeekDetails(pIdx, wIdx);
        });
    });
    if (phase.weeks && phase.weeks.length > 0) {
        const firstWeekButton = document.querySelector(`#week-navigation-${phaseIndex} .week-button`);
        if (firstWeekButton) {
            firstWeekButton.classList.add('active');
            renderWeekDetails(phaseIndex, 0);
        }
    }
}

function getDisplayKm(totalKmString) {
    if (!totalKmString || typeof totalKmString !== 'string') return 'N/A';
    const rangeMatch = totalKmString.match(/(\d+)\s*-\s*(\d+)/);
    if (rangeMatch) { return `${rangeMatch[2]}km`; }
    const singleMatch = totalKmString.match(/(\d+)/);
    if (singleMatch) { return `${singleMatch[1]}km`; }
    return totalKmString; 
}

function renderWeekDetails(phaseIndex, weekIndex) {
    if (!marathonPlan) return;
    const week = marathonPlan.phases[phaseIndex]?.weeks[weekIndex]; 
    if (!week) {
        console.error("Week not found for phase index:", phaseIndex, "week index:", weekIndex);
        const weekDetailsContainer = document.getElementById('week-details-container');
        if(weekDetailsContainer) weekDetailsContainer.innerHTML = '<p class="text-red-500">Error: Could not load week details.</p>';
        return;
    }
    const weekDetailsContainer = document.getElementById('week-details-container');
    const dayColors = ['bg-red-50', 'bg-orange-50', 'bg-amber-50', 'bg-yellow-50', 'bg-lime-50', 'bg-green-50', 'bg-emerald-50'];
    let tableRowsHtml = '';
    if (week.days && Array.isArray(week.days)) {
        tableRowsHtml = week.days.map((day, index) => {
            const parts = day.split(':');
            const dayName = parts[0].trim();
            const activity = parts.slice(1).join(':').trim();
            const bgColor = dayColors[index % dayColors.length]; 
            return `<tr class="${bgColor}">
                        <td class="p-3 font-medium text-stone-800">${dayName}</td>
                        <td class="p-3 text-stone-700">${activity}</td>
                    </tr>`;
        }).join('');
    } else {
        tableRowsHtml = '<tr><td colspan="2" class="p-3 text-stone-500">No daily schedule available.</td></tr>';
    }
    const displayKmValue = getDisplayKm(week.totalKm);
    if(weekDetailsContainer) weekDetailsContainer.innerHTML = `
        <div class="content-card mt-4">
            <h4 class="text-lg font-semibold text-sky-700 mb-2">Week ${week.weekNum}</h4>
            <p class="text-sm text-stone-600 mb-3"><strong>Total Mileage:</strong> ${displayKmValue}</p>
            <div class="overflow-x-auto rounded-lg border border-stone-200">
                <table class="schedule-table min-w-full">
                    <thead>
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider text-stone-600 bg-stone-100">Day</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider text-stone-600 bg-stone-100">Activity</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-200">
                        ${tableRowsHtml}
                    </tbody>
                </table>
            </div>
            ${week.notes ? `<p class="text-sm text-stone-600 italic mt-3 p-3 bg-stone-100 rounded-md"><strong>Notes:</strong> ${week.notes}</p>` : ''}
        </div>
    `;
}

// --- Calendar Tab ---
function getActivityThumbnailClass(activityText) {
    const lowerActivity = activityText.toLowerCase();
    if (lowerActivity.includes("race day")) return "activity-thumbnail-race";
    if (lowerActivity.startsWith("rest") || lowerActivity.includes("active recovery")) return "activity-thumbnail-rest";
    if (lowerActivity.startsWith("easy run")) return "activity-thumbnail-easy";
    if (lowerActivity.startsWith("tempo")) return "activity-thumbnail-tempo";
    if (lowerActivity.startsWith("interval")) return "activity-thumbnail-interval";
    if (lowerActivity.startsWith("long run")) return "activity-thumbnail-long";
    // "Base" is a phase, typically activities within it would be "Easy Run", "Long Run" etc.
    // If an activity specifically starts with "Base Run" (unlikely with current data) it could be added.
    // For now, other activities fall to default.
    return "activity-thumbnail-default"; 
}

function renderCalendarTab() {
    setActiveNav('nav-calendar');
    appContent.innerHTML = '';

    const calendarSection = document.createElement('section');
    calendarSection.id = "calendar-content";
    calendarSection.className = "space-y-6";

    // Use currentRaceDate (which is initialized from localStorage or default) for the input value
    const raceDateValue = currentRaceDate ? currentRaceDate.toISOString().split('T')[0] : DEFAULT_RACE_DATE_STRING;

    calendarSection.innerHTML = `
        <div class="content-card">
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-4">Training Calendar</h2>
            <div class="mb-6">
                <label for="raceDateInput" class="block text-sm font-medium text-stone-700 mb-1">Select Your Race Date:</label>
                <input type="date" id="raceDateInput" name="raceDateInput" value="${raceDateValue}"
                       class="mt-1 block w-full md:w-1/2 px-3 py-2 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                <p class="text-xs text-stone-500 mt-1">The calendar will schedule your training plan ending on this date.</p>
            </div>
            <div id="calendar-controls" class="flex justify-between items-center mb-4">
                <button id="prevMonthBtn" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-md text-sm">&lt; Prev</button>
                <h3 id="currentMonthYear" class="text-lg font-semibold text-stone-700"></h3>
                <button id="nextMonthBtn" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-md text-sm">Next &gt;</button>
            </div>
            <div id="calendar-grid-container" class="calendar-grid">
                </div>
        </div>
    `;
    appContent.appendChild(calendarSection);

    const raceDateInputEl = document.getElementById('raceDateInput');
    raceDateInputEl.addEventListener('change', (event) => {
        const newRaceDate = new Date(event.target.value + 'T00:00:00'); 
        if (isValidDate(newRaceDate)) {
            currentRaceDate = newRaceDate; // Update global currentRaceDate
            calculateAndStoreDatedTrainingPlan(newRaceDate);
            calendarCurrentDisplayDate = new Date(newRaceDate.getFullYear(), newRaceDate.getMonth(), 1);
            renderCalendarGrid();
            if (document.getElementById('nav-overview').classList.contains('active')) { // If overview is active, re-render it to update today's training
                 renderOverview();
            } else {
                 renderTodaysTraining(); // Or just update the today's training data if another tab is active
            }
        }
    });
    
    document.getElementById('prevMonthBtn').addEventListener('click', () => {
        calendarCurrentDisplayDate.setMonth(calendarCurrentDisplayDate.getMonth() - 1);
        renderCalendarGrid();
    });
    document.getElementById('nextMonthBtn').addEventListener('click', () => {
        calendarCurrentDisplayDate.setMonth(calendarCurrentDisplayDate.getMonth() + 1);
        renderCalendarGrid();
    });
    
    // Initial calendar render using the globally set calendarCurrentDisplayDate
    renderCalendarGrid();
}

function renderCalendarGrid() {
    const gridContainer = document.getElementById('calendar-grid-container');
    const monthYearDisplay = document.getElementById('currentMonthYear');
    if (!gridContainer || !monthYearDisplay) return;

    gridContainer.innerHTML = ''; 

    const year = calendarCurrentDisplayDate.getFullYear();
    const month = calendarCurrentDisplayDate.getMonth(); 

    monthYearDisplay.textContent = calendarCurrentDisplayDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });

    const firstDayOfMonth = new Date(year, month, 1);
    const lastDayOfMonth = new Date(year, month + 1, 0);
    const daysInMonth = lastDayOfMonth.getDate();
    let startingDayOfWeek = firstDayOfMonth.getDay(); 
    if (startingDayOfWeek === 0) startingDayOfWeek = 6; // Sunday is 0, make it 6 (0-Mon, 6-Sun)
    else startingDayOfWeek--; // Adjust other days

    const dayHeaders = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    dayHeaders.forEach(header => {
        const headerCell = document.createElement('div');
        headerCell.className = 'calendar-header';
        headerCell.textContent = header;
        gridContainer.appendChild(headerCell);
    });

    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day other-month';
        gridContainer.appendChild(emptyCell);
    }

    const today = new Date();
    today.setHours(0,0,0,0); // Normalize today for comparison

    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        const currentDateInLoop = new Date(year, month, day);
        currentDateInLoop.setHours(0,0,0,0); // Normalize for comparison

        if (isSameDay(currentDateInLoop, today)) {
            cell.classList.add('is-today');
        }

        let dayNumberSpan = `<span class="day-number">${day}</span>`;
        let activityHtml = '';

        if (datedTrainingPlan.length > 0) {
            const activityForDay = datedTrainingPlan.find(item => {
                const itemDate = new Date(item.date);
                itemDate.setHours(0,0,0,0); // Normalize item date
                return isSameDay(itemDate, currentDateInLoop);
            });
            if (activityForDay) {
                let activityText = activityForDay.activity.replace(/^[^:]+:\s*/, ''); 
                const thumbnailClass = getActivityThumbnailClass(activityText);
                activityHtml = `<span class="activity-thumbnail ${thumbnailClass}">${activityText.substring(0,12)}${activityText.length > 12 ? '...' : ''}</span>`;
            }
        }
        cell.innerHTML = dayNumberSpan + activityHtml;
        gridContainer.appendChild(cell);
    }
}


// --- Pace Utilities Tab ---
function renderPaceUtilities() {
    setActiveNav('nav-utils');
    appContent.innerHTML = ''; 
    const paceUtilsSection = document.createElement('section');
    paceUtilsSection.id = "pace-utils-content";
    paceUtilsSection.className = "space-y-6";
    paceUtilsSection.innerHTML = `
        <div class="content-card">
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-4">Training Zone & Repeats Pace Calculator</h2>
            <div class="mb-6">
                <label for="lt2speed" class="block text-sm font-medium text-stone-700 mb-1">Enter LT2 Speed (pace per km):</label>
                <input type="text" id="lt2speed" name="lt2speed" placeholder="e.g., 4:30"
                       class="mt-1 block w-full px-4 py-3 border border-stone-300 rounded-lg shadow-sm sm:text-sm transition duration-150 ease-in-out">
                <div id="error-message-calc" class="text-red-500 text-sm mt-2 h-5"></div>
            </div>
            <button onclick="calculatePacesFromUtil()"
                    class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition duration-150 ease-in-out transform hover:scale-105">
                Calculate Zones & Repeats Paces
            </button>
            <div class="mt-8 md:flex md:space-x-6">
                <div id="zones-section-util" class="flex-1">
                    <h3 class="text-lg font-semibold text-stone-700 mb-2 border-b border-stone-300 pb-2">Training Zones:</h3>
                    <div id="zones-content-util">
                        <p class="text-stone-500 italic text-sm">Enter your LT2 speed and click calculate.</p>
                    </div>
                </div>
                <div id="repeats-section-util" class="flex-1 mt-8 md:mt-0">
                    <h3 class="text-lg font-semibold text-stone-700 mb-2 border-b border-stone-300 pb-2">Repeats Paces:</h3>
                    <div id="repeats-content-util">
                        <p class="text-stone-500 italic text-sm">Calculated based on your LT2 speed.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    appContent.appendChild(paceUtilsSection);
     document.getElementById('lt2speed').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); 
            calculatePacesFromUtil();
        }
    });
}

function parsePaceToSeconds(paceString) { 
    if (!paceString || typeof paceString !== 'string') return NaN;
    const parts = paceString.trim().split(':');
    if (parts.length !== 2) return NaN;
    const minutes = parseInt(parts[0], 10);
    const seconds = parseInt(parts[1], 10);
    if (isNaN(minutes) || isNaN(seconds) || minutes < 0 || seconds < 0 || seconds >= 60) return NaN;
    return (minutes * 60) + seconds;
}
function formatSecondsToPace(totalSeconds) { 
    if (isNaN(totalSeconds) || totalSeconds < 0) return "N/A";
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = Math.round(totalSeconds % 60); 
    return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
}
function calculatePacesFromUtil() { 
    const lt2SpeedInput = document.getElementById('lt2speed').value;
    const zonesContentDiv = document.getElementById('zones-content-util');
    const repeatsContentDiv = document.getElementById('repeats-content-util');
    const errorMessageDivCalc = document.getElementById('error-message-calc');
    zonesContentDiv.innerHTML = '<p class="text-stone-500 italic text-sm">Calculating...</p>';
    repeatsContentDiv.innerHTML = '<p class="text-stone-500 italic text-sm">Calculating...</p>';
    if(errorMessageDivCalc) errorMessageDivCalc.textContent = ''; 
    const lt2SpeedInSeconds = parsePaceToSeconds(lt2SpeedInput);
    if (isNaN(lt2SpeedInSeconds) || lt2SpeedInSeconds <= 0) {
        if(errorMessageDivCalc) errorMessageDivCalc.textContent = 'Invalid LT2 speed. Use mm:ss format (e.g., 4:30). Pace must be positive.';
        zonesContentDiv.innerHTML = '<p class="text-red-500 italic text-sm">Could not calculate zones due to invalid input.</p>';
        repeatsContentDiv.innerHTML = '<p class="text-red-500 italic text-sm">Could not calculate repeats paces due to invalid LT2 input.</p>';
        return;
    }
    const zonesData = [
        { name: "Zone 1", descriptor: "Easy/Recovery", lowPaceFactor: 1.54, highPaceFactor: 1.33, colorClass: "text-green-600" }, 
        { name: "Zone 2", descriptor: "Aerobic/Base", lowPaceFactor: 1.32, highPaceFactor: 1.16, colorClass: "text-sky-600" }, 
        { name: "Zone 3", descriptor: "Tempo/Marathon", lowPaceFactor: 1.15, highPaceFactor: 1.01, colorClass: "text-lime-600" }, 
        { name: "Zone 4", descriptor: "Threshold", lowPaceFactor: 1.00, highPaceFactor: 0.91, colorClass: "text-amber-500" }, 
        { name: "Zone 5", descriptor: "VO2 Max", lowPaceFactor: 0.90, highPaceFactor: 0.83, colorClass: "text-red-600" } 
    ];
    const racePaceInfo = { name: "Marathon Pace (Est.)", descriptor: "", lowPaceFactor: 1.15, highPaceFactor: 1.10, colorClass: "text-purple-600" };
    zonesContentDiv.innerHTML = ''; 
    const zonesTable = document.createElement('table');
    zonesTable.classList.add('data-table', 'text-sm', 'w-full');
    zonesTable.innerHTML = `<thead><tr><th class="bg-stone-100 text-left p-2">Zone</th><th class="bg-stone-100 text-left p-2">Pace Range (/km)</th></tr></thead><tbody></tbody>`;
    const zonesTbody = zonesTable.querySelector('tbody');
    [...zonesData, racePaceInfo].forEach(zone => {
        const slowerPaceSeconds = lt2SpeedInSeconds * zone.lowPaceFactor;
        const fasterPaceSeconds = lt2SpeedInSeconds * zone.highPaceFactor;
        const row = zonesTbody.insertRow();
        row.insertCell().innerHTML = `<strong class="${zone.colorClass}">${zone.name} ${zone.descriptor ? '['+zone.descriptor+']' : ''}</strong>`;
        row.insertCell().textContent = `${formatSecondsToPace(fasterPaceSeconds)} - ${formatSecondsToPace(slowerPaceSeconds)}`;
    });
    zonesContentDiv.appendChild(zonesTable);
    zonesContentDiv.insertAdjacentHTML('beforeend', '<p class="text-xs text-stone-500 mt-2">Pace factors are estimates. Adjust based on feel and specific training goals.</p>');
    const repeatDistances = [
        { distance: "3000m", paceFactor: 1.02 }, { distance: "1600m (Mile)", paceFactor: 0.98 }, 
        { distance: "1000m", paceFactor: 0.95 }, { distance: "800m",  paceFactor: 0.92 },
        { distance: "400m",  paceFactor: 0.88 }, { distance: "200m",  paceFactor: 0.85 }
    ];
    repeatsContentDiv.innerHTML = ''; 
    const repeatsTable = document.createElement('table');
    repeatsTable.classList.add('data-table', 'text-sm', 'w-full');
    repeatsTable.innerHTML = `<thead><tr><th class="bg-stone-100 text-left p-2">Distance</th><th class="bg-stone-100 text-left p-2">Target Time per Repeat</th><th class="bg-stone-100 text-left p-2">Equivalent Pace (/km)</th></tr></thead><tbody></tbody>`;
    const repeatsTbody = repeatsTable.querySelector('tbody');
    repeatDistances.forEach(item => {
        const targetPacePerKmSeconds = lt2SpeedInSeconds * item.paceFactor;
        let distanceMultiplier = 1; 
        if (item.distance === "3000m") distanceMultiplier = 3;
        else if (item.distance === "1600m (Mile)") distanceMultiplier = 1.60934; 
        else if (item.distance === "1000m") distanceMultiplier = 1;
        else if (item.distance === "800m") distanceMultiplier = 0.8;
        else if (item.distance === "400m") distanceMultiplier = 0.4;
        else if (item.distance === "200m") distanceMultiplier = 0.2;
        const targetTimeForDistanceSeconds = targetPacePerKmSeconds * distanceMultiplier;
        const row = repeatsTbody.insertRow();
        row.insertCell().innerHTML = `<strong class="text-teal-700">${item.distance}</strong>`;
        row.insertCell().textContent = formatSecondsToPace(targetTimeForDistanceSeconds);
        row.insertCell().textContent = formatSecondsToPace(targetPacePerKmSeconds);
    });
    repeatsContentDiv.appendChild(repeatsTable);
    repeatsContentDiv.insertAdjacentHTML('beforeend', '<p class="text-xs text-stone-500 mt-2">Target times are estimates. Adjust based on the number of reps and recovery.</p>');
}

// --- Initial Load ---
fetchMarathonPlan();
// Script end
</script>
</body>
</html>
